/*
 * Copyright (C) 2012 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#define LOG_TAG "awb_al_ctrl"

#include "awb_ctrl.h"
#include "isp_awb.h"
#include "awb_packet.h"
#include "isp_com.h"
#include "ae_misc.h"
#include <cutils/properties.h>


#if  !defined( CONFIG_USE_ALC_AWB)  ||  !defined( CONFIG_USE_ALC_AE)
#error invalid make target...
#endif

//#define LSC_SIZE	(1280)	//20*16 *4 color
#define LSC_SIZE	(24*19*4)	//front is 24*19 *4 color

/*------------------------------------------------------------------------------*
*					Compiler Flag				*
*-------------------------------------------------------------------------------*/

#ifdef __cplusplus
extern "C"
{
#endif

/*------------------------------------------------------------------------------*
*					Micro Define				*
*-------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------*
*					structures				*
*-------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------*
*					local function declaration		*
*-------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------*
*					local variable				*
*-------------------------------------------------------------------------------*/

static const uint16_t lsc_ratio_pow15[20*16*4] = 
{
	/*Gr*/
	46138,43825,41834,40537,39506,38630,37898,37348,36970,36776,36784,36951,37294,37807,38478,39254,40257,41511,43723,46241,
	44193,42290,40652,39425,38387,37513,36812,36300,35952,35780,35777,35938,36255,36738,37392,38190,39163,40334,42061,44088,
	42602,41041,39649,38450,37402,36524,35849,35364,35037,34882,34871,35026,35329,35793,36431,37245,38210,39336,40700,42253,
	41685,40214,38877,37646,36591,35730,35084,34614,34293,34142,34133,34288,34591,35045,35658,36452,37440,38570,39835,41240,
	41129,39605,38224,36983,35934,35122,34485,34020,33716,33556,33553,33706,34008,34456,35056,35830,36803,37956,39208,40586,
	40679,39141,37746,36503,35475,34670,34043,33580,33278,33133,33134,33285,33581,34026,34620,35381,36341,37497,38750,40126,
	40383,38833,37429,36191,35182,34382,33760,33306,33011,32878,32874,33012,33304,33746,34341,35095,36035,37195,38460,39847,
	40260,38702,37287,36046,35051,34255,33632,33184,32900,32774,32770,32895,33177,33615,34207,34957,35899,37058,38332,39730,
	40290,38731,37319,36071,35075,34278,33659,33210,32920,32783,32781,32911,33192,33637,34227,34973,35913,37068,38350,39764,
	40491,38938,37530,36264,35254,34452,33832,33376,33081,32928,32930,33066,33350,33801,34394,35143,36093,37248,38533,39954,
	40836,39295,37896,36632,35594,34781,34154,33695,33384,33232,33226,33368,33657,34110,34705,35467,36429,37586,38867,40284,
	41289,39788,38421,37159,36094,35261,34623,34158,33848,33691,33683,33830,34115,34561,35161,35945,36933,38090,39354,40747,
	41955,40452,39093,37861,36779,35912,35256,34779,34459,34296,34291,34440,34727,35174,35792,36594,37585,38727,40026,41476,
	42947,41343,39918,38694,37631,36744,36057,35560,35226,35056,35045,35198,35506,35971,36614,37426,38395,39509,40909,42515,
	44502,42580,40917,39634,38591,37697,36979,36456,36110,35924,35906,36066,36382,36875,37531,38340,39319,40504,42048,43835,
	46304,44001,42011,40627,39600,38699,37947,37392,37033,36826,36799,36970,37292,37816,38488,39289,40297,41611,43324,45297,

	/*R*/
	50921,47788,45149,43454,42334,41203,40217,39484,38942,38694,38722,38969,39489,40279,41247,42308,43473,45226,48273,51881,
	48166,45728,43655,42093,40817,39645,38662,37933,37432,37201,37220,37458,37964,38723,39710,40853,42127,43720,45969,48648,
	45925,44052,42365,40847,39450,38241,37260,36535,36063,35842,35854,36089,36582,37320,38319,39526,40898,42412,44097,45966,
	44614,42915,41310,39703,38252,37035,36079,35386,34935,34718,34723,34961,35425,36138,37102,38329,39772,41333,42873,44489,
	43789,42059,40420,38751,37285,36093,35171,34499,34070,33862,33870,34092,34545,35231,36160,37361,38819,40471,41994,43547,
	43237,41437,39748,38048,36589,35424,34521,33870,33454,33260,33270,33490,33908,34571,35483,36654,38108,39803,41360,42960,
	42878,41028,39304,37593,36150,35001,34112,33486,33086,32908,32918,33117,33523,34162,35061,36205,37639,39340,40965,42672,
	42739,40855,39104,37375,35945,34808,33933,33315,32934,32771,32777,32947,33346,33975,34860,35998,37431,39129,40783,42541,
	42762,40880,39134,37413,35985,34841,33968,33346,32961,32789,32793,32973,33365,33994,34881,36025,37448,39155,40799,42535,
	42990,41140,39414,37695,36252,35098,34214,33582,33182,32989,32993,33186,33595,34234,35130,36279,37721,39414,41040,42752,
	43398,41611,39926,38215,36743,35582,34679,34024,33610,33410,33408,33610,34039,34699,35611,36771,38225,39908,41493,43141,
	44029,42302,40662,38991,37521,36315,35384,34707,34273,34057,34059,34278,34719,35398,36333,37532,38990,40625,42148,43707,
	44932,43207,41590,40003,38541,37308,36341,35639,35181,34962,34958,35195,35649,36360,37322,38545,39981,41537,43080,44705,
	46423,44467,42717,41171,39778,38560,37568,36836,36353,36124,36132,36374,36852,37586,38585,39779,41149,42655,44391,46345,
	48645,46068,43894,42313,41047,39879,38910,38163,37672,37425,37433,37684,38180,38912,39895,41031,42248,43838,46003,48567,
	51201,47878,45105,43442,42343,41241,40313,39551,39054,38786,38789,39051,39566,40294,41240,42303,43306,45064,47803,51087,

	/*B*/
	48549,45876,43604,41992,40900,39850,39006,38381,37901,37718,37724,37926,38314,38952,39753,40641,41744,43297,45997,49214,
	46081,44087,42332,40839,39635,38556,37711,37095,36672,36487,36487,36683,37069,37670,38464,39418,40562,41965,43945,46313,
	44123,42641,41218,39772,38490,37396,36554,35950,35566,35380,35377,35570,35952,36528,37316,38309,39488,40815,42282,43908,
	43026,41646,40270,38768,37467,36391,35582,35003,34625,34445,34442,34639,35008,35571,36341,37315,38513,39868,41188,42546,
	42464,40938,39471,37943,36635,35621,34833,34259,33890,33714,33722,33912,34280,34836,35580,36524,37723,39111,40420,41764,
	41976,40393,38887,37338,36062,35062,34288,33718,33355,33192,33198,33387,33752,34305,35035,35971,37147,38548,39866,41223,
	41653,40036,38508,36951,35694,34714,33941,33387,33032,32890,32898,33067,33419,33965,34699,35623,36784,38192,39526,40908,
	41533,39894,38348,36782,35550,34562,33794,33249,32908,32772,32775,32923,33267,33809,34541,35460,36619,38021,39388,40828,
	41579,39933,38383,36808,35577,34594,33837,33283,32936,32786,32790,32945,33288,33830,34565,35482,36638,38051,39410,40831,
	41794,40169,38632,37053,35789,34802,34043,33492,33137,32967,32969,33140,33487,34030,34765,35686,36844,38253,39611,41033,
	42133,40579,39076,37497,36210,35200,34434,33872,33508,33334,33332,33509,33858,34414,35137,36066,37251,38657,40002,41400,
	42481,41180,39722,38153,36839,35801,35015,34450,34081,33897,33894,34073,34429,34964,35704,36653,37859,39249,40560,41904,
	43180,41965,40533,39012,37676,36610,35802,35219,34835,34652,34649,34830,35186,35735,36489,37465,38656,40015,41360,42666,
	44572,43066,41529,40037,38740,37651,36801,36195,35803,35605,35597,35787,36158,36728,37514,38504,39651,40956,42499,44236,
	46645,44452,42559,41034,39837,38733,37870,37246,36835,36630,36606,36807,37199,37768,38570,39522,40648,42076,43815,45817,
	48891,46020,43611,42013,40954,39844,38982,38337,37900,37692,37646,37859,38278,38838,39645,40530,41646,43314,45247,46884,

	/*Gb*/
	45752,43558,41679,40438,39484,38647,37952,37422,37059,36890,36898,37055,37395,37914,38589,39347,40311,41565,43741,46235,
	43825,42025,40479,39315,38350,37518,36848,36348,36008,35846,35845,35999,36321,36812,37463,38248,39200,40362,42045,44022,
	42222,40757,39453,38329,37347,36518,35866,35389,35066,34907,34902,35052,35363,35832,36467,37274,38230,39333,40647,42136,
	41242,39888,38656,37517,36524,35715,35090,34627,34315,34159,34153,34304,34608,35060,35674,36461,37438,38537,39757,41110,
	40614,39252,38010,36866,35879,35102,34483,34025,33722,33566,33567,33713,34020,34465,35067,35832,36783,37899,39108,40437,
	40180,38795,37537,36395,35425,34650,34041,33587,33283,33137,33135,33290,33581,34028,34623,35380,36310,37442,38628,39919,
	39868,38489,37234,36085,35131,34370,33758,33300,33007,32881,32878,33016,33303,33747,34342,35084,36012,37133,38335,39650,
	39750,38357,37092,35943,35005,34238,33629,33182,32898,32773,32772,32898,33175,33615,34204,34947,35869,36987,38203,39538,
	39775,38386,37121,35966,35028,34259,33653,33206,32922,32782,32782,32912,33194,33636,34225,34965,35880,36998,38223,39572,
	39970,38582,37320,36155,35199,34433,33823,33374,33084,32934,32930,33065,33354,33798,34391,35131,36060,37187,38403,39738,
	40308,38935,37681,36510,35529,34759,34148,33689,33390,33241,33235,33371,33662,34112,34706,35459,36404,37528,38745,40083,
	40832,39463,38211,37034,36029,35235,34617,34163,33856,33702,33695,33840,34129,34575,35170,35942,36906,38034,39251,40585,
	41527,40146,38890,37732,36717,35890,35254,34784,34475,34315,34308,34454,34747,35197,35816,36611,37580,38688,39954,41370,
	42577,41077,39744,38589,37579,36737,36070,35585,35253,35088,35081,35237,35544,36011,36654,37461,38416,39506,40891,42488,
	44238,42374,40768,39544,38561,37699,37021,36494,36163,35981,35971,36137,36463,36951,37601,38405,39371,40542,42071,43847,
	46129,43852,41883,40550,39598,38709,38020,37440,37117,36909,36898,37072,37420,37935,38594,39394,40385,41692,43377,45172,
};

/*------------------------------------------------------------------------------*
*					local functions				*
*-------------------------------------------------------------------------------*/
void split_lsc_otp_random(uint16_t* buffer)
{
	uint16_t tmp[20*16*4];
	int i;

	memcpy((void*)tmp, (void*)buffer, 20*16*4*2);

	uint16_t* pbuf = buffer;
	for (i=0; i<20*16; i++)
	{
		*pbuf++ = tmp[4*i+0];
	}
	for (i=0; i<20*16; i++)
	{
		*pbuf++ = tmp[4*i+1];
	}
	for (i=0; i<20*16; i++)
	{
		*pbuf++ = tmp[4*i+2];
	}
	for (i=0; i<20*16; i++)
	{
		*pbuf++ = tmp[4*i+3];
	}
	
}


static void correct_lsc_otp_random_16_core(uint16_t* buffer, uint16_t* ratio)
{
	int i;

	uint16_t* pbuf_a = buffer;
	uint16_t* pbuf_b = ratio;
	for (i=0; i<20*16*4; i++)
	{
		uint16_t a = *pbuf_a;
		uint16_t b = *pbuf_b ++;
		uint32_t m = (a * b) + (1 << 14);
		*pbuf_a ++ = (uint16_t)(m >> 15);
	}
}
void correct_lsc_otp_random_16(uint16_t* buffer)
{
	correct_lsc_otp_random_16_core(buffer, lsc_ratio_pow15);
}



void fill_lsc_outer(uint16_t* buffer, int w, int h)
{
	int i, j;

	for (j=1; j<h-1; j++)
	{
		// left
		for (i=0; i<4; i++)
		{
			uint16_t a = buffer[j * w * 4 + i + 4];
			uint16_t b = buffer[j * w * 4 + i + 8];
			uint16_t c = buffer[j * w * 4 + i + 12];

			int16_t d = 3 * a - 3 * b + c;
			if (d < 1024) 
			{
				d = a;
			}
			else if (d > 16383) 
			{
				d = 16383;
			}

			buffer[j * w * 4 + i] = d;
		}

		// right
		for (i=4*w-4; i<4*w; i++)
		{
			uint16_t a = buffer[j * w * 4 + i - 4];
			uint16_t b = buffer[j * w * 4 + i - 8];
			uint16_t c = buffer[j * w * 4 + i - 12];

			int16_t d = 3 * a - 3 * b + c;
			if (d < 1024) 
			{
				d = a;
			}
			else if (d > 16383) 
			{
				d = 16383;
			}

			buffer[j * w * 4 + i] = d;
		}
	}

	// top line
	for (i=0; i<4*w; i++)
	{
		uint16_t a = buffer[1 * w * 4 + i];
		uint16_t b = buffer[2 * w * 4 + i];
		uint16_t c = buffer[3 * w * 4 + i];

		int16_t d = 3 * a - 3 * b + c;
		if (d < 1024) 
		{
			d = a;
		}
		else if (d > 16383) 
		{
			d = 16383;
		}

		buffer[i] = d;
	}

	// bottom line
	for (i=0; i<4*w; i++)
	{
		uint16_t a = buffer[(h-2) * w * 4 + i];
		uint16_t b = buffer[(h-3) * w * 4 + i];
		uint16_t c = buffer[(h-4) * w * 4 + i];

		int16_t d = 3 * a - 3 * b + c;
		if (d < 1024) 
		{
			d = a;
		}
		else if (d > 16383) 
		{
			d = 16383;
		}

		buffer[(h-1) * w * 4 + i] = d;
	}
}


